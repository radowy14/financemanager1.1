<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Finance Manager CH</title>
  <style>
    :root{
      --bg:#0b1220;
      --card:#111a2e;
      --muted:#9fb0d0;
      --text:#eef2ff;
      --line:rgba(255,255,255,.10);
      --accent:#6ea8ff;
      --warn:#fbbf24;
      --ok:#2dd4bf;
      --bad:#fb7185;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 600px at 20% 10%, rgba(110,168,255,.18), transparent 60%),
                  radial-gradient(900px 450px at 80% 20%, rgba(45,212,191,.12), transparent 60%),
                  var(--bg);
      color:var(--text);
    }
    header{
      padding:28px 18px 10px;
      max-width:1180px;
      margin:0 auto;
    }
    h1{margin:0 0 6px; font-size:22px; letter-spacing:.2px}
    p{margin:0; color:var(--muted); line-height:1.45}
    .wrap{
      max-width:1180px;
      margin:0 auto;
      padding:18px;
      display:grid;
      grid-template-columns: 1.35fr .65fr;
      gap:16px;
    }
    @media (max-width: 980px){
      .wrap{grid-template-columns:1fr}
    }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius:14px;
      padding:16px;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }
    .card h2{
      margin:0 0 12px;
      font-size:16px;
      letter-spacing:.2px;
    }
    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media (max-width: 640px){
      .grid{grid-template-columns:1fr}
    }
    label{
      display:block;
      font-size:12px;
      color:var(--muted);
      margin:0 0 6px;
    }
    input, select{
      width:100%;
      padding:10px 10px;
      border-radius:10px;
      border:1px solid var(--line);
      background: rgba(17,26,46,.75);
      color:var(--text);
      outline:none;
    }
    input:focus, select:focus{border-color: rgba(110,168,255,.65)}
    .toggle{
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border:1px solid var(--line);
      border-radius:12px;
      background: rgba(17,26,46,.55);
    }
    .toggle input{width:auto}
    .small{font-size:12px; color:var(--muted)}
    .btns{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px}
    button{
      border:1px solid var(--line);
      background: rgba(110,168,255,.12);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
    }
    button:hover{border-color: rgba(110,168,255,.55)}
    .danger{background: rgba(251,113,133,.10)}
    .sep{height:1px; background:var(--line); margin:12px 0}
    .note{
      border-left:3px solid var(--warn);
      padding:10px 12px;
      background: rgba(251,191,36,.08);
      border-radius:10px;
      color:var(--text);
    }
    .kpi{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    .kpi .box{
      border:1px solid var(--line);
      border-radius:12px;
      padding:12px;
      background: rgba(17,26,46,.55);
    }
    .kpi .muted{color:var(--muted); font-size:12px}
    .kpi .v{font-size:18px; margin-top:4px}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace}
    table{
      width:100%;
      border-collapse:collapse;
      font-size:12px;
    }
    th, td{
      padding:10px 8px;
      border-bottom:1px solid var(--line);
      text-align:right;
      vertical-align:middle;
      white-space:nowrap;
    }
    th:first-child, td:first-child{ text-align:left; }
    .pill{
      display:inline-block;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(110,168,255,.10);
      color: var(--text);
      font-size:12px;
    }
    .muted{color:var(--muted)}
    .statusline{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      padding:10px 12px;
      border:1px solid var(--line);
      border-radius:12px;
      background: rgba(17,26,46,.55);
    }
  </style>
</head>
<body>
  <header>
    <h1>Finance Manager (CH)</h1>
    <p>v1.2: PLZ → Gemeinde/Kanton automatisch. Steuern aktuell als Schätzung (bis Tarife/Steuerfüsse vollständig integriert sind).</p>
  </header>

  <main class="wrap">
    <section class="card">
      <h2>Eingaben</h2>

      <div class="grid">
        <div>
          <label>Netto-Lohn pro Monat (CHF)</label>
          <input id="netMonthly" inputmode="decimal" placeholder="z. B. 6500" />
          <div class="small">Netto = ausbezahlt (nach AHV/ALV/BVG etc.).</div>
        </div>

        <div>
          <label>Brutto-Lohn pro Monat (optional, CHF)</label>
          <input id="grossMonthly" inputmode="decimal" placeholder="z. B. 8000" />
          <div class="small">Wenn leer: Brutto wird nicht „erraten“, sondern leer gelassen.</div>
        </div>

        <div>
          <label>Postleitzahl (CH)</label>
          <input id="plz" inputmode="numeric" placeholder="z. B. 3000" />
          <div class="small">Wir ermitteln Gemeinde/Kanton automatisch via PLZ-Liste.</div>
        </div>

        <div>
          <label>Ortschaft/Gemeinde (falls mehrere Treffer)</label>
          <select id="placePick" disabled>
            <option>PLZ eingeben…</option>
          </select>
          <div class="small">Manche PLZ kommen mehrfach vor (verschiedene Ortschaften/Gemeinden).</div>
        </div>

        <div>
          <label>Berechnungsjahr</label>
          <select id="taxYear">
            <option value="2025">2025</option>
            <option value="2026">2026</option>
          </select>
        </div>

        <div class="statusline" style="align-self:end;">
          <div><span class="pill">Ermittelt</span></div>
          <div class="small">
            <div>Gemeinde: <span class="mono" id="outGemeinde">—</span></div>
            <div>Kanton: <span class="mono" id="outKanton">—</span> | BFS: <span class="mono" id="outBfs">—</span></div>
          </div>
        </div>
      </div>

      <div class="sep"></div>

      <div class="toggle" style="margin-bottom:10px;">
        <input type="checkbox" id="customDeductions" />
        <div>
          <div><strong>Abzüge manuell erfassen</strong> <span class="pill">optional</span></div>
          <div class="small">Wenn aus: pauschaler Abzug (vereinfachtes Modell).</div>
        </div>
      </div>

      <div id="deductionsBox" style="display:none;">
        <div class="grid">
          <div>
            <label>Abzüge total pro Jahr (CHF)</label>
            <input id="deductionsYearly" inputmode="decimal" placeholder="z. B. 9000" />
          </div>
          <div>
            <label>Zusätzliche steuerbare Einkünfte pro Jahr (CHF)</label>
            <input id="extraTaxableYearly" inputmode="decimal" placeholder="z. B. 0" />
          </div>
        </div>
      </div>

      <div class="sep"></div>

      <h2>13. Monatslohn (konfigurierbar)</h2>
      <div class="small" style="margin-bottom:10px;">
        Beispiel: 50% im Juni und 50% im Dezember. Wenn du keinen 13. hast: alles auf 0 lassen.
      </div>

      <div class="grid">
        <div>
          <label>Auszahlung 1 – Monat</label>
          <select id="m13_1_month">
            <option value="0">—</option>
            <option value="1">Jan</option><option value="2">Feb</option><option value="3">Mär</option><option value="4">Apr</option>
            <option value="5">Mai</option><option value="6">Jun</option><option value="7">Jul</option><option value="8">Aug</option>
            <option value="9">Sep</option><option value="10">Okt</option><option value="11">Nov</option><option value="12">Dez</option>
          </select>
        </div>
        <div>
          <label>Auszahlung 1 – Prozent vom 13. (%)</label>
          <input id="m13_1_pct" inputmode="decimal" placeholder="z. B. 50" />
        </div>

        <div>
          <label>Auszahlung 2 – Monat</label>
          <select id="m13_2_month">
            <option value="0">—</option>
            <option value="1">Jan</option><option value="2">Feb</option><option value="3">Mär</option><option value="4">Apr</option>
            <option value="5">Mai</option><option value="6">Jun</option><option value="7">Jul</option><option value="8">Aug</option>
            <option value="9">Sep</option><option value="10">Okt</option><option value="11">Nov</option><option value="12">Dez</option>
          </select>
        </div>
        <div>
          <label>Auszahlung 2 – Prozent vom 13. (%)</label>
          <input id="m13_2_pct" inputmode="decimal" placeholder="z. B. 50" />
        </div>
      </div>

      <div class="sep"></div>

      <h2>Fixkosten (Monat)</h2>
      <div class="grid">
        <div>
          <label>Miete (CHF)</label>
          <input id="rentMonthly" inputmode="decimal" placeholder="z. B. 1800" />
        </div>
        <div>
          <label>Krankenkasse (CHF)</label>
          <input id="healthMonthly" inputmode="decimal" placeholder="z. B. 350" />
        </div>
        <div>
          <label>Weitere Versicherungen (CHF)</label>
          <input id="insMonthly" inputmode="decimal" placeholder="z. B. 80" />
        </div>
        <div>
          <label>Weitere Fixkosten (CHF)</label>
          <input id="otherFixedMonthly" inputmode="decimal" placeholder="z. B. 450" />
        </div>
      </div>

      <div class="btns">
        <button id="calcBtn">Berechnen</button>
        <button id="saveBtn">Eingaben speichern</button>
        <button id="resetBtn" class="danger">Zurücksetzen</button>
      </div>

      <div class="sep"></div>
      <div class="note">
        <strong>Wichtig:</strong>
        <div class="small" style="margin-top:6px; color:var(--text); opacity:.95">
          Die Steuer hier ist aktuell eine <span class="mono">Schätzung</span>. Für „definitiv korrekt“ brauchen wir entweder (a) steuerbares Einkommen
          oder (b) echte Tarife/Steuerfüsse vollständig integriert (Bund/Kanton/Gemeinde).
        </div>
      </div>
    </section>

    <aside class="card">
      <h2>Ergebnis</h2>

      <div class="kpi">
        <div class="box">
          <div class="muted">Netto-Jahreslohn</div>
          <div class="v" id="netYearOut">CHF 0</div>
          <div class="muted">12× Netto + 13. gemäss Auszahlung</div>
        </div>
        <div class="box">
          <div class="muted">Brutto-Jahreslohn (optional)</div>
          <div class="v" id="grossYearOut">—</div>
          <div class="muted">nur wenn Brutto eingegeben</div>
        </div>

        <div class="box">
          <div class="muted">Steuer total pro Jahr (Schätzung)</div>
          <div class="v" id="taxYearOut">CHF 0</div>
          <div class="muted" id="taxExplain">—</div>
        </div>
        <div class="box">
          <div class="muted">Steuer-Rücklage pro Monat</div>
          <div class="v" id="taxMonthlyOut">CHF 0</div>
          <div class="muted">empfohlen: konstant zurücklegen</div>
        </div>

        <div class="box">
          <div class="muted">Steuer-Aufteilung (in Arbeit)</div>
          <div class="v" style="font-size:14px; line-height:1.35">
            Bund: <span class="mono">—</span><br/>
            Kanton: <span class="mono">—</span><br/>
            Gemeinde: <span class="mono">—</span>
          </div>
          <div class="muted">wird mit echten Tarifen ergänzt</div>
        </div>

        <div class="box">
          <div class="muted">Übrig pro Monat (Ø)</div>
          <div class="v" id="freeMonthlyOut">CHF 0</div>
          <div class="muted">Netto − Fixkosten − Steuer-Rücklage</div>
        </div>
      </div>

      <div class="sep"></div>

      <h2>Monatsübersicht (Cashflow)</h2>
      <div class="small muted" style="margin-bottom:8px;">
        Netto inkl. 13.-Auszahlung(en) in den gewählten Monaten. Steuer wird als monatliche Rücklage verteilt.
      </div>

      <div style="overflow:auto; border:1px solid var(--line); border-radius:12px;">
        <table>
          <thead>
            <tr>
              <th>Monat</th>
              <th>Netto</th>
              <th>Fixkosten</th>
              <th>Steuer-RL</th>
              <th>Übrig</th>
            </tr>
          </thead>
          <tbody id="cashflowBody"></tbody>
        </table>
      </div>
    </aside>
  </main>

  <script>
    const STORAGE_KEY = "financeManagerCH_v12";

    // ESTV Gemeindeliste (PLZ → Gemeinde/Kanton/BFS). Quelle: ESTV.
    const ESTV_PLZ_CSV =
      "https://www.estv.admin.ch/dam/estv/de/dokumente/qst/qst-gemeindeliste-2025-de.csv.download.csv/qst-gemeindeliste-2025-de.csv";

    const MONTHS = ["Jan","Feb","Mär","Apr","Mai","Jun","Jul","Aug","Sep","Okt","Nov","Dez"];

    function chf(x){
      if (!isFinite(x)) x = 0;
      return "CHF " + Math.round(x).toLocaleString("de-CH");
    }

    function num(v){
      if (v === null || v === undefined) return 0;
      const s = String(v).replace(/\s/g,"").replace(",",".");
      const n = Number(s);
      return isFinite(n) ? n : 0;
    }

    function clamp(x, lo, hi){ return Math.max(lo, Math.min(hi, x)); }

    // v1: bewusst als Schätzung markiert
    function estimateEffectiveRate(taxableYear, canton){
      let base;
      if (taxableYear <= 35000) base = 0.06;
      else if (taxableYear <= 60000) base = 0.10;
      else if (taxableYear <= 90000) base = 0.13;
      else if (taxableYear <= 130000) base = 0.16;
      else if (taxableYear <= 180000) base = 0.20;
      else base = 0.24;

      // minimale kantonale Differenz (nur Näherung)
      const cantonAdj = (canton === "ZH") ? -0.004 : (canton === "BE" ? +0.004 : 0.00);
      return clamp(base + cantonAdj, 0.03, 0.32);
    }

    // --- PLZ → Gemeinde/Kanton/BFS ---
    let plzIndexLoaded = false;
    let plzRows = []; // [{ort,plz,gemeinde,bfs,kt,validFrom}]
    let currentMatches = [];
    let selectedMatch = null;

    function parseCsvLine(line){
      // CSV ist semikolon-separiert
      // Ortschaftsname;PLZ;Gemeindename;BFS-Nr;Kantonskürzel;Gültig ab
      const parts = line.split(";");
      return {
        ort: (parts[0] || "").trim(),
        plz: (parts[1] || "").trim(),
        gemeinde: (parts[2] || "").trim(),
        bfs: (parts[3] || "").trim(),
        kt: (parts[4] || "").trim(),
        validFrom: (parts[5] || "").trim()
      };
    }

    async function loadPlzIndexOnce(){
      if (plzIndexLoaded) return;
      const res = await fetch(ESTV_PLZ_CSV, { cache: "no-store" });
      if (!res.ok) throw new Error("PLZ-Liste konnte nicht geladen werden.");
      const text = await res.text();

      const lines = text.split(/\r?\n/).filter(l => l.trim().length > 0);
      // erste Zeile ist Header
      const dataLines = lines.slice(1);
      plzRows = dataLines.map(parseCsvLine).filter(r => r.plz);
      plzIndexLoaded = true;
    }

    function updatePlacePicker(matches){
      const sel = document.getElementById("placePick");
      sel.innerHTML = "";

      if (!matches.length){
        sel.disabled = true;
        sel.innerHTML = "<option>Keine Treffer</option>";
        return;
      }

      sel.disabled = matches.length === 1;

      matches.forEach((m, idx) => {
        const opt = document.createElement("option");
        opt.value = String(idx);
        opt.textContent = `${m.ort} → ${m.gemeinde} (${m.kt})`;
        sel.appendChild(opt);
      });

      sel.value = "0";
    }

    function setSelectedMatchByIndex(idx){
      selectedMatch = currentMatches[idx] || null;

      document.getElementById("outGemeinde").textContent = selectedMatch ? selectedMatch.gemeinde : "—";
      document.getElementById("outKanton").textContent = selectedMatch ? selectedMatch.kt : "—";
      document.getElementById("outBfs").textContent = selectedMatch ? selectedMatch.bfs : "—";
    }

    async function onPlzChanged(){
      const plz = (document.getElementById("plz").value || "").trim();
      if (plz.length < 4){
        currentMatches = [];
        updatePlacePicker(currentMatches);
        setSelectedMatchByIndex(0);
        compute();
        return;
      }

      try{
        await loadPlzIndexOnce();
        currentMatches = plzRows.filter(r => r.plz === plz);
        updatePlacePicker(currentMatches);
        setSelectedMatchByIndex(0);
      }catch(e){
        currentMatches = [];
        updatePlacePicker(currentMatches);
        setSelectedMatchByIndex(0);
      }

      compute();
    }

    function compute(){
      const netMonthly = num(document.getElementById("netMonthly").value);
      const grossMonthly = num(document.getElementById("grossMonthly").value);

      const taxYear = document.getElementById("taxYear").value;

      const rentMonthly = num(document.getElementById("rentMonthly").value);
      const healthMonthly = num(document.getElementById("healthMonthly").value);
      const insMonthly = num(document.getElementById("insMonthly").value);
      const otherFixedMonthly = num(document.getElementById("otherFixedMonthly").value);

      const customDeductions = document.getElementById("customDeductions").checked;
      const deductionsYearly = customDeductions ? num(document.getElementById("deductionsYearly").value) : 0;
      const extraTaxableYearly = customDeductions ? num(document.getElementById("extraTaxableYearly").value) : 0;

      // 13. Monatslohn
      const m13_1_month = Number(document.getElementById("m13_1_month").value || 0);
      const m13_2_month = Number(document.getElementById("m13_2_month").value || 0);
      const m13_1_pct = clamp(num(document.getElementById("m13_1_pct").value), 0, 100);
      const m13_2_pct = clamp(num(document.getElementById("m13_2_pct").value), 0, 100);

      const thirteenthFactor = (m13_1_pct + m13_2_pct) / 100;
      const netYear = (netMonthly * 12) + (netMonthly * thirteenthFactor);

      // Brutto-Jahr (optional)
      const grossYear = grossMonthly > 0 ? (grossMonthly * 12) + (grossMonthly * thirteenthFactor) : null;

      // Pauschalabzug (Schätzung)
      const standardDeduction = customDeductions ? 0 : clamp(netYear * 0.08, 4000, 12000);

      // Kanton aus PLZ
      const canton = selectedMatch ? selectedMatch.kt : "OTHER";

      // „taxableYear“ bleibt eine Näherung – klar markiert
      const taxableYear = Math.max(0, netYear + extraTaxableYearly - (customDeductions ? deductionsYearly : standardDeduction));

      const effRate = estimateEffectiveRate(taxableYear, canton);
      const taxYearEst = taxableYear * effRate;
      const taxMonthlyReserve = taxYearEst / 12;

      const fixedMonthly = rentMonthly + healthMonthly + insMonthly + otherFixedMonthly;
      const freeMonthlyAvg = netMonthly - fixedMonthly - taxMonthlyReserve;

      // Outputs
      document.getElementById("netYearOut").textContent = chf(netYear);
      document.getElementById("grossYearOut").textContent = grossYear === null ? "—" : chf(grossYear);

      document.getElementById("taxYearOut").textContent = chf(taxYearEst);
      document.getElementById("taxMonthlyOut").textContent = chf(taxMonthlyReserve);
      document.getElementById("freeMonthlyOut").textContent = chf(freeMonthlyAvg);

      const placeStr = selectedMatch ? `${selectedMatch.gemeinde} (${selectedMatch.kt})` : "—";
      const explain = customDeductions
        ? `Jahr ${taxYear} | Ort: ${placeStr} | steuerbar≈Netto-Jahr + Zusatz − Abzüge | eff. Satz≈${(effRate*100).toFixed(1)}% (Schätzung)`
        : `Jahr ${taxYear} | Ort: ${placeStr} | pauschaler Abzug≈${chf(standardDeduction)} | eff. Satz≈${(effRate*100).toFixed(1)}% (Schätzung)`;
      document.getElementById("taxExplain").textContent = explain;

      // Monats-Cashflow
      const tbody = document.getElementById("cashflowBody");
      tbody.innerHTML = "";

      const add13 = Array(12).fill(0);
      if (m13_1_month >= 1 && m13_1_month <= 12) add13[m13_1_month - 1] += netMonthly * (m13_1_pct / 100);
      if (m13_2_month >= 1 && m13_2_month <= 12) add13[m13_2_month - 1] += netMonthly * (m13_2_pct / 100);

      for (let i = 0; i < 12; i++){
        const monthNet = netMonthly + add13[i];
        const leftover = monthNet - fixedMonthly - taxMonthlyReserve;

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${MONTHS[i]}</td>
          <td>${chf(monthNet)}</td>
          <td>${chf(fixedMonthly)}</td>
          <td>${chf(taxMonthlyReserve)}</td>
          <td>${chf(leftover)}</td>
        `;
        tbody.appendChild(tr);
      }
    }

    function syncDeductionsUI(){
      const on = document.getElementById("customDeductions").checked;
      document.getElementById("deductionsBox").style.display = on ? "block" : "none";
    }

    function save(){
      const ids = [
        "netMonthly","grossMonthly","plz","placePick","taxYear",
        "rentMonthly","healthMonthly","insMonthly","otherFixedMonthly",
        "deductionsYearly","extraTaxableYearly",
        "m13_1_month","m13_1_pct","m13_2_month","m13_2_pct"
      ];
      const data = {};
      ids.forEach(id => data[id] = (document.getElementById(id) ? document.getElementById(id).value : ""));
      data.customDeductions = document.getElementById("customDeductions").checked;
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    }

    function load(){
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return;
      try{
        const data = JSON.parse(raw);
        Object.keys(data).forEach(k => {
          const el = document.getElementById(k);
          if(!el) return;
          if(el.type === "checkbox") el.checked = !!data[k];
          else el.value = data[k];
        });
        document.getElementById("customDeductions").checked = !!data.customDeductions;
      }catch(e){}
    }

    function resetAll(){
      localStorage.removeItem(STORAGE_KEY);
      location.reload();
    }

    document.getElementById("calcBtn").addEventListener("click", compute);
    document.getElementById("saveBtn").addEventListener("click", () => { save(); compute(); });
    document.getElementById("resetBtn").addEventListener("click", resetAll);

    document.getElementById("customDeductions").addEventListener("change", () => { syncDeductionsUI(); compute(); });
    document.getElementById("plz").addEventListener("input", () => { onPlzChanged(); });

    document.getElementById("placePick").addEventListener("change", (e) => {
      const idx = Number(e.target.value || 0);
      setSelectedMatchByIndex(idx);
      compute();
    });

    // initial
    load();
    syncDeductionsUI();
    onPlzChanged();
  </script>
</body>
</html>

